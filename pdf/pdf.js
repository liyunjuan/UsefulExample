var totalPages;var width;var height;var filename;var keyfrom;var pagectrl="convert.do";var proxyctrl="proxy.do";var fileQueryStr;var pdfPages;var pdfThumbs;var thumbsConvertQueue=new Array();var threshold=200;var thumbPaneWidth=230;var controlPaneHeight=71;var currentPage=-1;var lastThumb=-1;var pageScrollStamp=0;var thumbScrollStamp=0;var mainScroll,thumbScroll;var pageScrollEvent,thumbScrollEvent;$(document).ready(function(){pdfPages=new Array(totalPages);pdfThumbs=new Array(totalPages);var c=150;var g=Math.round(c*(height/width));for(var d=0;d<totalPages;d++){pdfPages[d]={};pdfPages[d].status=false;pdfPages[d].width=width;pdfPages[d].maxWidth=width;pdfPages[d].height=height;pdfPages[d].image="";pdfThumbs[d]={};pdfThumbs[d].status=false;pdfThumbs[d].width=c;pdfThumbs[d].height=g;pdfThumbs[d].image="";}var f="";var b="";var a=$("#thumbList").children(".wrapper");var e=$("#mainContainer").children(".wrapper");for(var d=0;d<totalPages;d++){e.append($('<div class="page" style="width:'+pdfPages[d].width+"px;height:"+pdfPages[d].height+'px">'+'<p class="page-number">正在加载第'+(d+1)+"页</p></div>"));a.append($('<div class="thumb" onclick="scrollToPage('+d+')" style="width: '+pdfThumbs[d].width+"px; height: "+pdfThumbs[d].height+'px"></div>'));a.append($('<p class="page-number">'+(d+1)+"</p>"));}if(isTouch()){document.addEventListener("touchmove",function(h){h.preventDefault();},false);}else{$("#mainContainer").scroll(onPageScroll);$("#thumbList").scroll(onThumbScroll);}$("#pageselect").change(function(){var h=parseInt($(this).val());scrollToPage(h-1);});adjustSize();window.onresize=adjustSize;});function isTouch(){var a=(/hp-tablet/gi).test(navigator.appVersion);return !!document.addEventListener&&"ontouchstart" in window&&!a;}if(isTouch()){document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){mainScroll=new iScroll("mainContainer",{onScrollMove:onPageScroll});thumbScroll=new iScroll("thumbList",{onScrollMove:onThumbScroll});},200);},false);}function adjustSize(){var a=document.documentElement.clientHeight;var c=document.documentElement.clientWidth;$("#thumbList").css("height",(a-controlPaneHeight-1)+"px");$("#mainContainer").css("height",a+"px");if(a>0){var b=$("#mainContainer").height()-controlPaneHeight-1;$("#thumbList").css("height",b+"px");}else{$("#thumbList").css("height","0px");}$("#mainContainer").css("width",(c-thumbPaneWidth)+"px");onPageScroll();onThumbScroll();}function getDisplayRange(g,j,a,d){var e={};e.begin=0;e.end=1;e.current=0;var b=0;var h=d-1;var k=(b+h)>>1;while(k>b){var f=$(g[k]).position();if(f.top+j[k].height<0){b=k+1;k=(b+h)>>1;}else{if(f.top>a){h=k-1;k=(b+h)>>1;}else{break;}}}e.begin=k;e.end=k;e.current=k;for(var c=k-1;c>=0;--c){var f=$(g[c]).position();if(f.top+j[c].height>0){e.begin=c;}else{break;}}for(var c=k+1;c<d;++c){var f=$(g[c]).position();if(f.top<a){e.end=c;}else{break;}}if(e.end>=d){e.end=d-1;}for(var c=e.begin;c<=e.end;++c){var f=$(g[c]).position();if(f.top<threshold){e.current=c;}else{break;}}return e;}function getDisplayPageRange(){var c=$(".page");var a=pdfPages;var b=$("#mainContainer").height();return getDisplayRange(c,a,b,totalPages);}function getDisplayThumbRange(){var c=$(".thumb");var a=pdfThumbs;var b=$("#thumbList").height();return getDisplayRange(c,a,b,totalPages);}function updatePdfHTML(a,b){a.css("height",b.height);a.css("width",b.width);a.html('<img src="'+generateImageUrl(b.image)+'"></img>');}function updatePageHTML(a){var b=$(".page:eq("+a+")");updatePdfHTML(b,pdfPages[a]);}function updateThumbHTML(a){var b=$(".thumb:eq("+a+")");updatePdfHTML(b,pdfThumbs[a]);}function loadPages(b){for(var d=b.begin;d<=b.end;++d){var c=(d-b.begin)*Math.floor((1+Math.random())*50);var a=pdfPages[d].width;window.setTimeout("loadPage("+d+", "+a+");",c);}}function loadPage(d,b){var a={begin:d,end:d,current:d};var b=pdfPages[d].width;var c=generateConvertUrl(a,b);$.getJSON(c,function(e){if(e.width!=b){return;}if(pdfPages[d].status==false){pdfPages[d].status=true;pdfPages[d].height=e.height;pdfPages[d].width=e.width;pdfPages[d].maxWidth=e.width;pdfPages[d].image=e.pageInfos[0].imageFilename;updatePageHTML(d);}});}function loadThumbs(b){var a=new Array();for(var c=b.begin;c<=b.end;++c){a.push(c);}thumbsConvertQueue=a;loadThumb();}function loadThumb(){var d=thumbsConvertQueue.shift();if(d===undefined){return;}var a={begin:d,end:d,current:d};var b=pdfThumbs[d].width;var c=generateConvertUrl(a,b);$.getJSON(c,function(e){if(e.width==b&&pdfThumbs[d].status==false){pdfThumbs[d].status=true;pdfThumbs[d].height=e.height;pdfThumbs[d].width=e.width;pdfThumbs[d].maxWidth=e.width;pdfThumbs[d].image=e.pageInfos[0].imageFilename;updateThumbHTML(d);}loadThumb();});}function scrollToPage(a){if(isTouch()){mainScroll.scrollToElement($(".page:eq("+a+")")[0],200);}else{$("#mainContainer").scrollTo(".page:eq("+a+")",200);}}function updatePageSelect(a){$(".pselect[selected=true]").attr("selected",false);$("#pselect"+(a+1)).attr("selected",true);}function updateCurrentThumb(d){if(d==lastThumb){return;}var b=$(".thumb");$(b[lastThumb]).removeClass("thumb-highlight");$(b[d]).addClass("thumb-highlight");lastThumb=d;if(isTouch()){var e=$(b[d]).position();var a=e.top+thumbScroll.y;var c=$("#thumbList").height();if(a<0||a+pdfThumbs[d].height>c){thumbScroll.scrollToElement($(".thumb:eq("+d+")")[0],200);}}else{var e=$(b[d]).position();var c=$("#thumbList").height();if(e.top<0||e.top+pdfThumbs[d].height>c){$("#thumbList").scrollTo(".thumb:eq("+d+")",200);}}}function handleScroll(e,d,a){var c=true;var g=0;var b=0;for(var f=0;f<=e.end-e.begin;++f){if(c&&d[f+e.begin].status===true){b=f-1;if(b>=g){a({begin:g+e.begin,end:b+e.begin});}g=0;c=false;}else{if(!c&&d[f+e.begin].status!==true){g=f;c=true;}}}if((g!==0||(g===0&&b===0))&&c===true){a({begin:g+e.begin,end:e.end});}}function handlePageScroll(c){if(c!=pageScrollStamp){return;}var d=getDisplayPageRange();var b=pdfPages;var a=loadPages;handleScroll(d,b,a);updatePageSelect(d.current);updateCurrentThumb(d.current);}function handleThumbScroll(c){if(c!=thumbScrollStamp){return;}var d=getDisplayThumbRange();var b=pdfThumbs;var a=loadThumbs;handleScroll(d,b,a);}function onPageScroll(){++pageScrollStamp;if(pageScrollEvent){clearTimeout(pageScrollEvent);}pageScrollEvent=setTimeout("handlePageScroll("+pageScrollStamp+");",700);}function onThumbScroll(){++thumbScrollStamp;if(thumbScrollEvent){clearTimeout(thumbScrollEvent);}thumbScrollEvent=setTimeout("handleThumbScroll("+thumbScrollStamp+");",700);}function zoomin(){$(".active-btn").removeClass("active-btn");var a=Math.min(width+200,2000);a=Math.round(a/200)*200;zoom(a);}function zoomout(){$(".active-btn").removeClass("active-btn");var a=Math.max(width-200,200);a=Math.round(a/200)*200;zoom(a);}function fitWidth(){$(".active-btn").removeClass("active-btn");$("#fitWidthBtn").addClass("active-btn");var a=$("#mainContainer").width()-30;zoom(a);}function fitPage(){$(".active-btn").removeClass("active-btn");$("#fitPageBtn").addClass("active-btn");var c=getDisplayPageRange().current;var b=$("#mainContainer").height();var a=(pdfPages[c].width/pdfPages[c].height)*b;zoom(a);scrollToPage(c);}function zoom(d){height=Math.round((height/width)*d);width=Math.round(d);var h=$("#mainContainer").children(".wrapper");var c=$(h).height();var g=$("#mainContainer").scrollTop();var j=$(".page");for(var e=0;e<totalPages;e++){if(width>pdfPages[e].maxWidth){pdfPages[e].status=false;pdfPages[e].image="";}pdfPages[e].width=width;pdfPages[e].height=height;$(j[e]).css({width:width+"px",height:height+"px"});var f=$(j[e]).children("img");f.attr("width",width);f.attr("height",height);}var a=$(h).height();var b=Math.round((a/c)*g);$("#mainContainer").scrollTo(""+b+"px");onPageScroll();}function generateImageUrl(b){var a=proxyctrl+"?"+fileQueryStr+"&filename="+encodeURIComponent(b)+"&keyfrom="+keyfrom;return a;}function generateConvertUrl(a,c){var b=pagectrl+"?"+fileQueryStr+"&filename="+encodeURIComponent(filename)+"&startPage="+(a.begin+1)+"&endPage="+(a.end+1)+"&width="+c+"&keyfrom="+keyfrom;return b;}function prevPage(){var a=getDisplayPageRange();scrollToPage(Math.max(0,a.current-1));}function nextPage(){var a=getDisplayPageRange();scrollToPage(Math.min(totalPages-1,a.current+1));}